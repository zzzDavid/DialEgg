(include "../../../src/base.egg") ; The tests are run from "build/test/stablehlo"

;;;; StableHLO Dialect ;;;;
(function stablehlo_multiply (Op Op Type) Op)
(function stablehlo_add (Op Op Type) Op)
(function stablehlo_constant (AttrPair Type) Op)

;; OPS HERE ;;
; mul2_func.func
(let op0 (Value 0 (RankedTensor (vec-of 4) (F64))))
(let op1 (stablehlo_constant (NamedAttr "value" (DenseFPElementsAttr (vec-of 2.000000e+00 2.000000e+00 2.000000e+00 2.000000e+00) (RankedTensor (vec-of 4) (F64)))) (RankedTensor (vec-of 4) (F64))))
(let op2 (stablehlo_multiply op0 op1 (RankedTensor (vec-of 4) (F64))))
(let op3 (Value 3 (None)))

;; RULES HERE ;;
(ruleset rules)

(let c2f (stablehlo_constant
  (NamedAttr "value"
             (DenseFPElementsAttr (vec-of 2.0 2.0 2.0 2.0) (RankedTensor (vec-of 4) (F64))))
  (RankedTensor (vec-of 4) (F64))))

(rewrite ; x * 2 = x + x
  (stablehlo_multiply ?x c2f ?a)
  (stablehlo_add ?x ?x ?a)
  :ruleset rules)

(rewrite ; a * (b + c) = a * b + a * c
  (stablehlo_multiply ?a (stablehlo_add ?b ?c ?t) ?t)
  (stablehlo_add (stablehlo_multiply ?a ?b ?t) (stablehlo_multiply ?a ?c ?t) ?t)
  :ruleset rules)

(run-schedule (saturate rules))

;; EXTRACTS HERE ;;
(extract op2)
